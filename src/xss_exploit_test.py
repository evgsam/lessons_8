import requests
import os
from dotenv import load_dotenv
from scapy.all import *
import re

#–Ω–µ —Å–≤–µ—á—É —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ –≤ –∫–æ–¥–µ
load_dotenv()
my_id = os.getenv("MY_ID")
username = os.getenv("USERNAME")
password = os.getenv("PSWRD")

#—Ç—Ä–∞—Ñ–∏–∫ –ø–µ—Ä—Ö–≤–∞—á—É —á–µ—Ä–µ–∑ scapy, –ø–æ—ç—Ç–æ–º—É http
base_url = f"http://google-gruyere.appspot.com/" 
#–î–≤–∞ –≤–∏–¥–∞ xss –∞—Ç–∞–∫ –∏–∑ —É—Å–ª–æ–≤–∏–π –î–ó
xss_input_1 = "<script>alert('test')</script>"
xss_input_2 = "<img src=\"nonexistent.jpg\" onerror=\"alert('XSS')\">"
#–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º—ã—Ö –ø–∞–∫–µ—Ç–æ–≤
pkg_count = 100
#–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –ø–µ—Ä—Ö–≤–∞—Ç, –ª—É—á—à–µ –∫–æ–Ω–µ—á–Ω–æ —Å–ø—Ä–∞—à–∏–≤–∞—Ç—å, –Ω–æ –¥–ª—è —Ç–µ—Å—Ç–∞ –∏ –î–ó –±—É–¥–µ—Ç –∂–µ—Å—Ç–∫–æ –≤—ã–±—Ä–∞–Ω
interface = "eth0"

#–¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ –≤—ã–≤–æ–∂—É —Å—Ç–∞—Ç—É—Å—ã –æ—Ç–≤–µ—Ç–æ–≤
def handle_status(code):
    if code == 200:
        print("–£—Å–ø–µ—à–Ω–æ!")
        return
    #–æ—à–∏–±–∫–∏
    errors = {
        404: "–†–µ—Å—É—Ä—Å –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ URL.",
        429: "–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤. –ü–æ–¥–æ–∂–¥–∏—Ç–µ.",
        403: "–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω.",
        401: "–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è.",
    }
    
    if code in errors:
        raise Exception(f"{code}: {errors[code]}")
    elif code >= 500:
        raise Exception(f"{code}: –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞.")
    else:
        raise Exception(f"{code}: –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞.")

def post_req(url, data = None, auth = None, timeout = None):
    response = requests.post(
        url,
        data=data,
        auth=auth,
        timeout=timeout
    )
    handle_status(response.status_code)
    return response 



#–ø–µ—Ä–µ—Ö–≤–∞—Ç —Ç—Ä–∞—Ñ–∏–∫–∞ –≤–æ –≤—Ä–µ–º—è post-–∑–∞–ø—Ä–æ—Å–∞
def sniff_during_post(url, post_data=None):
    print("–ó–∞–ø—É—Å–∫–∞—é –ø–µ—Ä–µ—Ö–≤–∞—Ç –≤–æ –≤—Ä–µ–º—è POST –∑–∞–ø—Ä–æ—Å–∞")
    print(f"–¶–µ–ª–µ–≤–æ–π URL: {url}")
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º —Å–Ω–∏—Ñ—Ñ–µ—Ä –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ
    sniff_thread = threading.Thread(
        target=simple_sniff,
        args=(urlparse(url).hostname, 10)
    )
    
    # –î–∞–µ–º –≤—Ä–µ–º—è –Ω–∞ –∑–∞–ø—É—Å–∫ —Å–Ω–∏—Ñ—Ñ–µ—Ä–∞
    time.sleep(1)
    
    print("\nüì§ –û—Ç–ø—Ä–∞–≤–ª—è—é POST –∑–∞–ø—Ä–æ—Å...")
    
    try:
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º POST –∑–∞–ø—Ä–æ—Å
        post_req(
            url,
            data = post_data, 
            timeout=10
        )       

        # –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å–Ω–∏—Ñ—Ñ–µ—Ä–∞
        sniff_thread.join()
        
        return response
        
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ POST: {e}")
        return None

    

#–≠–¢–ê–ü 1 –õ–æ–≥–∏–≥–Ω–∏–º—Å—è
print(f"–õ–æ–≥–∏–Ω–∏–º—Å—è –Ω–∞ —Å–∞–π—Ç–µ {base_url}")
post_req(
    base_url + my_id + "/login",
    auth=(username, password)
)

#–≠–¢–ê–ü 1 –≤–∫–ª—é—á–∞—é –ø–µ—Ä—Ö–≤–∞—Ç —Ç—Ä–∞—Ñ–∏–∫–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –ø–æ–≤–µ–¥–µ–Ω–∏—è –ø—Ä–∏ –∞—Ç–∞–∫–µ
sniff_during_post(base_url+my_id, "/"+xss_input_1)